.PHONY: deploy start stop status help postgres backend ui labeling health
.DEFAULT_GOAL := help

ifneq (,$(wildcard ../../.env))
# ifneq (,$(filter local,$(MAKECMDGOALS)))
include ../../.env
# endif
endif

# PID files for process management
BACKEND_PID_FILE := .backend.pid
UI_PID_FILE := .ui.pid  
LABELING_PID_FILE := .labeling.pid

deploy: start ## Deploy all services (alias for start)

help: ## Show this help message
	@echo "ðŸš€ Ansible Log Monitor - Local Deployment"
	@echo ""
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-12s %s\n", $$1, $$2}'
	@echo ""


start: stop ## ðŸš€ Start all services locally
	@echo "ðŸš€ Starting local deployment of Ansible Log Monitor..."
	@echo "ðŸ”Œ Cleaning up any existing processes..."
	# @$(MAKE) -s postgres
	@sleep 3
	@$(MAKE) -s backend
	@sleep 1
	@$(MAKE) -s ui
	@$(MAKE) -s labeling
	@echo ""
	@echo "ðŸŽ‰ All services are running!"
	@$(MAKE) -s status
	@echo ""
	@echo "Press Ctrl+C to stop all services, or run 'make stop'"

postgres: ## ðŸ“Š Start PostgreSQL database
	scripts/postgres.sh

backend: ## âš™ï¸ Start Backend (FastAPI)
	scripts/backend.sh

ui: ## ðŸ–¥ï¸ Start UI (Gradio)
	scripts/ui.sh

labeling: ## ðŸ·ï¸ Start Labeling UI (Gradio)  
	scripts/labeling.sh

stop: ## ðŸ›‘ Stop all services
	@echo "ðŸ›‘ Stopping all services..."
	@if [ -f $(BACKEND_PID_FILE) ]; then \
		if kill -0 `cat $(BACKEND_PID_FILE)` 2>/dev/null; then \
			kill `cat $(BACKEND_PID_FILE)` 2>/dev/null; \
			echo "   âœ“ Backend stopped"; \
		fi; \
		rm -f $(BACKEND_PID_FILE); \
	fi
	@if [ -f $(UI_PID_FILE) ]; then \
		if kill -0 `cat $(UI_PID_FILE)` 2>/dev/null; then \
			kill `cat $(UI_PID_FILE)` 2>/dev/null; \
			echo "   âœ“ UI stopped"; \
		fi; \
		rm -f $(UI_PID_FILE); \
	fi
	@if [ -f $(LABELING_PID_FILE) ]; then \
		if kill -0 `cat $(LABELING_PID_FILE)` 2>/dev/null; then \
			kill `cat $(LABELING_PID_FILE)` 2>/dev/null; \
			echo "   âœ“ Labeling UI stopped"; \
		fi; \
		rm -f $(LABELING_PID_FILE); \
	fi
	# docker-compose down
	@echo "   âœ“ PostgreSQL stopped"
	@$(MAKE) -s kill-ports
	@echo "ðŸ‘‹ All services stopped"

kill-ports: ## ðŸ”Œ Kill processes using required ports
	@fuser -k 7860/tcp 2>/dev/null || true
	@fuser -k 7861/tcp 2>/dev/null || true
	@fuser -k 8000/tcp 2>/dev/null || true

status: ## ðŸ“Š Show status of all services
	@echo "ðŸ“Š Service Status:"
	@echo "   ðŸ“Š PostgreSQL: $(shell docker-compose ps -q postgres >/dev/null 2>&1 && echo 'Running' || echo 'Stopped') - localhost:5432"
	@if [ -f $(BACKEND_PID_FILE) ] && kill -0 `cat $(BACKEND_PID_FILE)` 2>/dev/null; then \
		echo "   âš™ï¸  Backend API: Running - http://localhost:8000"; \
	else \
		echo "   âš™ï¸  Backend API: Stopped - http://localhost:8000"; \
	fi
	@if [ -f $(UI_PID_FILE) ] && kill -0 `cat $(UI_PID_FILE)` 2>/dev/null; then \
		echo "   ðŸ–¥ï¸  UI Interface: Running - http://localhost:7860"; \
	else \
		echo "   ðŸ–¥ï¸  UI Interface: Stopped - http://localhost:7860"; \
	fi
	@if [ -f $(LABELING_PID_FILE) ] && kill -0 `cat $(LABELING_PID_FILE)` 2>/dev/null; then \
		echo "   ðŸ·ï¸  Labeling UI: Running - http://localhost:7861"; \
	else \
		echo "   ðŸ·ï¸  Labeling UI: Stopped - http://localhost:7861"; \
	fi

health: ## ðŸ” Check health of running services
	@echo "ðŸ” Health Checks:"
	@if curl -s http://localhost:8000/health >/dev/null 2>&1; then \
		echo "   âš™ï¸  Backend: Healthy"; \
	else \
		echo "   âš™ï¸  Backend: Unhealthy"; \
	fi
	@if curl -s http://localhost:7860 >/dev/null 2>&1; then \
		echo "   ðŸ–¥ï¸  UI: Healthy"; \
	else \
		echo "   ðŸ–¥ï¸  UI: Unhealthy"; \
	fi
	@if curl -s http://localhost:7861 >/dev/null 2>&1; then \
		echo "   ðŸ·ï¸  Labeling UI: Healthy"; \
	else \
		echo "   ðŸ·ï¸  Labeling UI: Unhealthy"; \
	fi

logs: ## ðŸ“ Show logs for all services
	@echo "ðŸ“ Service Logs:"
	@echo "=== Backend Logs ==="
	@tail -20 .backend.log 2>/dev/null || echo "No backend logs found"
	@echo "=== UI Logs ===" 
	@tail -20 .ui.log 2>/dev/null || echo "No UI logs found"
	@echo "=== Labeling UI Logs ==="
	@tail -20 .labeling.log 2>/dev/null || echo "No labeling UI logs found"
	@echo "=== PostgreSQL Logs ==="
	@docker-compose logs --tail=20 postgres 2>/dev/null || echo "No PostgreSQL logs found"

restart: stop start ## ðŸ”„ Restart all services
